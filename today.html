<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Today</title>
<link rel="stylesheet" href="styles.css">
<style>
/* page specific layout only */
body { margin: 0; padding: 0; }
/* header styling removed to defer to global stylesheet */
#todaySection { padding: 1rem; border-bottom: 2px solid #e2e5e9; margin-bottom: 1rem; }
#container { display: flex; }
#side { width: 50%; padding: 1rem; border-right: 1px solid #ccc; }
#main { flex: 1; padding: 1rem; }
.task-list { list-style: none; padding: 0; }
.task-list li { margin: 0.25rem 0; padding: 0.25rem; border-bottom: 1px solid #ddd; display:flex; justify-content: space-between; align-items:center; flex-wrap:wrap; }
#todayListContainer{width:100%;}
.overdue { color: red; }
.due { color: orange; }
.due-soon { font-weight: bold; }
.today-item { cursor: move; }

/* Modal styles */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: none; width: 90%; max-width: 1200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.close:hover, .close:focus { color: black; text-decoration: none; }

/* Task grid for modal */
.task-grid { display: grid; grid-template-columns: 2fr repeat(7, 1fr); gap: 0.5rem; border: 1px solid #e2e5e9; background: #fff; padding: 0.5rem; border-radius: 4px; }
.task-grid div { padding: 0.5rem; border: 1px solid #e2e5e9; text-align: center; }
.grid-header { background: #C7BBB4; font-weight: bold; color: #2B2C29; }
.task-info { display: flex; justify-content: space-between; align-items: center; text-align: left; }
.task-details { flex: 1; }
.task-name { font-size: 0.9rem; font-weight: 500; color: #2B2C29; }
.task-meta { font-size: 0.8rem; color: #7D7D7D; }
.task-actions { display: flex; gap: 0.25rem; }
.circle { display: inline-block; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; }
.purple { background: #B5A89A; }
.grey { background: #ccc; }
.green { background: #81B29A; color: #fff; }

@media (max-width: 600px) {
  html { font-size: 14px; }
  .modal-content { width: 95%; margin: 2% auto; }
  .task-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<header>
  <h1>Today</h1>
</header>
<div id="nav-placeholder"></div>
<script src="nav-loader.js"></script>

<!-- Today Section at the top -->
<div id="todaySection">
  <h2>Today</h2>
  <input type="text" id="quickInput" placeholder="New item">
  <button onclick="addQuickItem()">Add</button>
  <button onclick="clearToday()">Clear</button>
  <div id="todayListContainer">
    <ul id="todayList" class="task-list"></ul>
  </div>
</div>

<!-- Side pickers (work/DIY/stretch/big) below -->
<div id="container">
  <div id="side">
    <label style="display:block;margin-top:0.5rem;"><input type="checkbox" id="workToggle"> Show Work Tasks</label>
    <ul id="workTaskList" class="task-list hidden"></ul>
    <label style="display:block;margin-top:0.5rem;"><input type="checkbox" id="diyToggle"> Show DIY Tasks</label>
    <ul id="diyTaskList" class="task-list hidden"></ul>
    <label style="display:block;margin-top:0.5rem;"><input type="checkbox" id="stretchToggle"> Show Stretch Tasks</label>
    <ul id="stretchTaskList" class="task-list hidden"></ul>
    <label style="display:block;margin-top:0.5rem;"><input type="checkbox" id="bigToggle"> Show Big Tasks</label>
    <ul id="bigTaskList" class="task-list hidden"></ul>
    <label style="display:block;margin-top:0.5rem;"><input type="checkbox" id="diyBigToggle"> Show DIY Big Tasks</label>
    <ul id="diyBigTaskList" class="task-list hidden"></ul>
    <label style="display:block;margin-top:0.5rem;"><input type="checkbox" id="devToggle"> Show Development Activities</label>
    <ul id="devTaskList" class="task-list hidden"></ul>
  </div>
  <div id="main">
    <!-- This can be used for additional content later -->
  </div>
</div>

<!-- To Do Tasks Section -->
<div id="todoTasksSection" style="padding: 1rem; border-top: 2px solid #e2e5e9; margin-top: 1rem;">
  <h2>To Do Tasks</h2>
  <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
    <button onclick="openWeeklyTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Weekly Tasks</button>
  <button onclick="openOneOffTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">One-Off Tasks</button>
  <button onclick="openRecurringTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Recurring Tasks</button>
  <button onclick="openWorkTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Work Tasks</button>
  <button onclick="openDiyTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">DIY Tasks</button>
  <button onclick="openBigTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Big Tasks</button>
  <button onclick="openStretchTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Stretch Tasks</button>
  </div>
</div>

<!-- Weekly Tasks Modal -->
<div id="weeklyTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: none; width: 90%; max-width: 1200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">Weekly Tasks</h3>
      <span class="close" onclick="closeWeeklyTasksModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    </div>
    <div class="modal-body">
      <div class="week-controls" style="text-align: center; margin-bottom: 1rem;">
        <button onclick="changeModalWeek(-1)" style="padding: 0.5rem 1rem; margin: 0 0.5rem; background: #C7BBB4; border: none; border-radius: 4px; cursor: pointer;">&#8592;</button>
        <span id="modalWeekLabel" style="font-weight:bold;color:#2B2C29; margin: 0 1rem;"></span>
        <button onclick="changeModalWeek(1)" style="padding: 0.5rem 1rem; margin: 0 0.5rem; background: #C7BBB4; border: none; border-radius: 4px; cursor: pointer;">&#8594;</button>
      </div>
      <div id="modalWeeklyGrid" class="task-grid" style="display: grid; grid-template-columns: 2fr repeat(7, 1fr); gap: 0.5rem; border: 1px solid #e2e5e9; background: #fff;">
        <!-- Grid content will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- One-Off Tasks Modal -->
<div id="oneOffTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">One-Off Tasks</h3>
      <span class="close" onclick="closeOneOffTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalOneOffTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- Recurring Tasks Modal -->
<div id="recurringTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Recurring Tasks</h3>
      <span class="close" onclick="closeRecurringTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalRecurringTable" style="overflow:auto;"></div>
    </div>
  </div>
</div>

<!-- Work Tasks Modal -->
<div id="workTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Work Tasks</h3>
      <span class="close" onclick="closeWorkTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalWorkTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- DIY Tasks Modal -->
<div id="diyTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">DIY Tasks</h3>
      <span class="close" onclick="closeDiyTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalDiyTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- Big Tasks Modal -->
<div id="bigTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Big Tasks</h3>
      <span class="close" onclick="closeBigTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalBigTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- Stretch Tasks Modal -->
<div id="stretchTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Stretch Tasks</h3>
      <span class="close" onclick="closeStretchTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalStretchTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<script>
let projects=[], weeklyTasks=[], oneOffTasks=[], recurringTasks=[], stretchTasks=[], bigTasks=[], deletedTasks=[], shoppingList=[], longTermList=[], generalList=[], parentingSkills=[], parentingActivities=[], parentingNextSkillId=1, parentingNextActivityId=1;
let todayList=[], todayTasks=[], todayQuickHistory=[];
// Removed Overdue/Due Soon lists
let nextId=1;
let workDataStore={}, workTasks=[], workCalendar=[];
let diyDataStore={}, diyTasks=[], diyBigTasks=[], diyCalendar=[];
function getWorkTaskInfo(id,list=workTasks,depth=0,parent=null){
  for(const t of list){
    if(t.id===id) return {task:t,parent,depth};
    if(t.subtasks){
      const r=getWorkTaskInfo(id,t.subtasks,depth+1,t);
      if(r) return r;
    }
  }
  return null;
}
function forEachWorkTask(cb,list=workTasks,depth=0,parent=null){
  list.forEach(t=>{
    cb(t,depth,parent);
    if(t.subtasks) forEachWorkTask(cb,t.subtasks,depth+1,t);
  });
}
function getDiyTaskInfo(id,list=diyTasks,depth=0,parent=null){
  for(const t of list){
    if(t.id===id) return {task:t,parent,depth};
    if(t.subtasks){
      const r=getDiyTaskInfo(id,t.subtasks,depth+1,t);
      if(r) return r;
    }
  }
  return null;
}
function forEachDiyTask(cb,list=diyTasks,depth=0,parent=null){
  list.forEach(t=>{
    cb(t,depth,parent);
    if(t.subtasks) forEachDiyTask(cb,t.subtasks,depth+1,t);
  });
}
function taskScheduledToday(type,id){
  const today=formatISO(new Date());
  let events=[];
  if(type==='work') events=workCalendar;
  else if(type==='diy') events=diyCalendar;
  else return false;
  return events.some(ev=>ev.taskId===id && ev.start.slice(0,10)===today);
}
function formatISO(date){const d=new Date(date);const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function formatUK(date){const d=new Date(date);if(isNaN(d)) return date||'';return d.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'2-digit'});}
function startOfWeek(date){const d=new Date(date);const day=d.getDay();const diff=(day===0?-6:1-day);d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;}
function prevDueDate(task,date){const days=task.days.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].indexOf(d));const d=new Date(date);for(let i=0;i<7;i++){if(days.includes(d.getDay())) return new Date(d);d.setDate(d.getDate()-1);}return null;}
function nextDueDate(task,date){const days=task.days.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].indexOf(d));const d=new Date(date);for(let i=0;i<7;i++){if(days.includes(d.getDay())) return new Date(d);d.setDate(d.getDate()+1);}return null;}
function nearestDueDate(task,date){const prev=prevDueDate(task,date);const next=nextDueDate(task,date);if(!prev) return formatISO(next);if(!next) return formatISO(prev);const mid=new Date(prev.getTime()+(next-prev)/2);return date<mid?formatISO(prev):formatISO(next);}
function lastDueDate(task){return prevDueDate(task,new Date());}
function updateMissed(task){const last=new Date(task.dateLastChecked);const today=new Date();let d=new Date(last);while(d<=today){const dayName=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];const iso=formatISO(d);if(d>last&&task.days.includes(dayName)){if(!task.completedDates.includes(iso)&&!task.missedDates.includes(iso)){task.missedDates.push(iso);}}d.setDate(d.getDate()+1);}task.dateLastChecked=formatISO(today);saveData();}
async function loadData(){
  try{
    const res=await fetch('/api/index-data');
    if(res.ok){
      const obj=await res.json();
      projects=obj.projects||[];weeklyTasks=obj.weeklyTasks||[];oneOffTasks=obj.oneOffTasks||[];recurringTasks=obj.recurringTasks||[];
      stretchTasks=obj.stretchTasks||[];bigTasks=obj.bigTasks||[];deletedTasks=obj.deletedTasks||[];shoppingList=obj.shoppingList||[];longTermList=obj.longTermList||[];
      generalList=obj.generalList||[];todayList=obj.todayList||[];todayQuickHistory=obj.todayQuickHistory||[];nextId=obj.nextId||1;
    }
    const resW=await fetch('/api/work-data');
    if(resW.ok){
      workDataStore=await resW.json();
      workTasks=workDataStore.workTasks||[];
      workCalendar=workDataStore.calendarEvents||[];
    }
    const resD=await fetch('/api/diy-data');
    if(resD.ok){
      diyDataStore=await resD.json();
      diyTasks=diyDataStore.diyTasks||[];
      diyBigTasks=diyDataStore.diyBigTasks||[];
      diyCalendar=diyDataStore.calendarEvents||[];
    }
    const resP=await fetch('/api/parenting-data');
    if(resP.ok){
      const pd=await resP.json();
      parentingSkills=pd.skills||[];
      parentingActivities=pd.activities||[];
      parentingNextSkillId=pd.nextSkillId||1;
      parentingNextActivityId=pd.nextActivityId||1;
    }
  }catch(e){console.error('Failed to load data',e);}
}
async function saveData(){const data={projects,weeklyTasks,oneOffTasks,recurringTasks,stretchTasks,bigTasks,deletedTasks,shoppingList,longTermList,generalList,todayList,nextId,todayQuickHistory};try{await fetch('/api/index-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});}catch(e){console.error('Failed to save data',e);}}
async function saveWorkData(){
  workDataStore.workTasks = workTasks;
  try{
    await fetch('/api/work-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(workDataStore)});
  }catch(e){console.error('Failed to save work data',e);}
}
async function saveDiyData(){
  diyDataStore.diyTasks = diyTasks;
  diyDataStore.diyBigTasks = diyBigTasks;
  try{
    await fetch('/api/diy-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(diyDataStore)});
  }catch(e){console.error('Failed to save diy data',e);}
}
async function saveParentingData(){
  const data={skills:parentingSkills,activities:parentingActivities,nextSkillId:parentingNextSkillId,nextActivityId:parentingNextActivityId};
  try{await fetch('/api/parenting-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});}catch(e){console.error('Failed to save parenting data',e);}
}
// Removed categorize/overdue logic
function rebuildToday(){
  todayTasks=[];
  todayList.forEach(r=>{
    if(r.type==='quick'){
      todayTasks.push({category:'quick',type:'quick',item:r});
      return;
    }
    // Support both local shape {type,id} and server shape {type,originalId}
    const refId = (r.id !== undefined) ? r.id : (r.originalId !== undefined ? r.originalId : undefined);
    let arr;
    if(r.type==='oneoff') arr=oneOffTasks;
    else if(r.type==='recurring') arr=recurringTasks;
    else if(r.type==='weekly') arr=weeklyTasks;
    else if(r.type==='stretch') arr=stretchTasks;
    else if(r.type==='big') arr=bigTasks;
    else if(r.type==='diybig') arr=diyBigTasks;
    else if(r.type==='dev') arr=parentingActivities;
    let task=null, depth=0;
    if(r.type==='work'){
      const info=getWorkTaskInfo(r.id);
      if(info){ task=info.task; depth=info.depth; }
    }else if(r.type==='diy'){
      const info=getDiyTaskInfo(r.id);
      if(info){ task=info.task; depth=info.depth; }
    }else if(arr){
      task=arr.find(t=>t.id===refId);
    }
    if(!task) return;
    if(r.type==='work'){
      todayTasks.push({category:'work',type:'work',item:task,depth});
      return;
    } else if(r.type==='diy'){
      todayTasks.push({category:'diy',type:'diy',item:task,depth});
      return;
    } else if(r.type==='stretch'){
      todayTasks.push({category:'stretch',type:'stretch',item:task});
      return;
    } else if(r.type==='big'){
      todayTasks.push({category:'big',type:'big',item:task});
      return;
    } else if(r.type==='diybig'){
      todayTasks.push({category:'diybig',type:'diybig',item:task});
      return;
    } else if(r.type==='dev'){
      todayTasks.push({category:'dev',type:'dev',item:task});
      return;
    }
  // No overdue/due buckets anymore; just push a simple today item
  todayTasks.push({category:'today',type:r.type,item:task});
  });
}
function renderSide(){
  if(document.getElementById('workToggle').checked) renderWorkTasks();
  if(document.getElementById('diyToggle').checked) renderDiyTasks();
  if(document.getElementById('stretchToggle').checked) renderStretchTasks();
  if(document.getElementById('bigToggle').checked) renderBigTasks();
  if(document.getElementById('diyBigToggle').checked) renderDiyBigTasks();
  if(document.getElementById('devToggle').checked) renderDevTasks();
}
function renderWorkTasks(){
  const ul=document.getElementById('workTaskList');
  ul.innerHTML='';
  forEachWorkTask((t,depth)=>{
    if(t.status!=='open') return;
    const li=document.createElement('li');
    li.style.paddingLeft=(depth)+'rem';
    li.textContent=`[Work] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addWorkToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderDiyTasks(){
  const ul=document.getElementById('diyTaskList');
  ul.innerHTML='';
  forEachDiyTask((t,depth)=>{
    if(t.status!=='open') return;
    const li=document.createElement('li');
    li.style.paddingLeft=(depth)+'rem';
    li.textContent=`[DIY] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addDiyToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderStretchTasks(){
  const ul=document.getElementById('stretchTaskList');
  ul.innerHTML='';
  stretchTasks.filter(t=>t.status==='open').forEach(t=>{
    const li=document.createElement('li');
    li.textContent=`[Todo - stretch] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addStretchToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderBigTasks(){
  const ul=document.getElementById('bigTaskList');
  ul.innerHTML='';
  bigTasks.filter(t=>t.status==='open').forEach(t=>{
    const li=document.createElement('li');
    li.textContent=`[Todo - big] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addBigToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderDiyBigTasks(){
  const ul=document.getElementById('diyBigTaskList');
  ul.innerHTML='';
  diyBigTasks.filter(t=>t.status==='open').forEach(t=>{
    const li=document.createElement('li');
    li.textContent=`[DIY - big] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addDiyBigToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}

function renderDevTasks(){
  const ul=document.getElementById('devTaskList');
  ul.innerHTML='';
  parentingActivities.filter(a=>a.status==='open').forEach(a=>{
    const skill=parentingSkills.find(s=>s.id===a.skillId);
    const li=document.createElement('li');
    li.textContent=`[Parenting - dev] ${a.name} (${skill?skill.name:''})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addDevToToday(a.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}

function addDevToToday(id){
  const task=parentingActivities.find(a=>a.id===id);
  if(!task) return;
  todayTasks.push({category:'dev',type:'dev',item:task});
  todayList.push({type:'dev',id});
  saveData();
  saveParentingData();
  renderToday();
}
function updateToggles(){
  const wt=document.getElementById('workToggle');
  const dt=document.getElementById('diyToggle');
  const bt=document.getElementById('bigToggle');
  const db=document.getElementById('diyBigToggle');
  const dv=document.getElementById('devToggle');
  document.getElementById('workTaskList').classList.toggle('hidden', !wt.checked);
  document.getElementById('diyTaskList').classList.toggle('hidden', !dt.checked);
  document.getElementById('bigTaskList').classList.toggle('hidden', !bt.checked);
  document.getElementById('diyBigTaskList').classList.toggle('hidden', !db.checked);
  document.getElementById('devTaskList').classList.toggle('hidden', !dv.checked);
}
function renderToday(){
  const ul=document.getElementById('todayList');
  ul.innerHTML='';
  todayTasks.forEach((t,i)=>{
    const li=document.createElement('li');
    li.className='today-item';
    li.draggable=true;
    li.dataset.index=i;
    if(t.depth) li.style.paddingLeft=(t.depth)+'rem';
    const text=document.createElement('span');
    let page='', label='', prefix='';
    if(t.type==='quick'){
      label=t.item.name;
    }else{
      if(['oneoff','recurring','weekly','stretch','big'].includes(t.type)) page='Todo';
      else if(t.type==='work') page='Work';
      else if(t.type==='diy' || t.type==='diybig') page='DIY';
      else if(t.type==='dev') page='Parenting';
      let projectText='';
      if(t.type==='dev'){
        const skill=parentingSkills.find(s=>s.id===t.item.skillId);
        projectText=skill?skill.name:'';
      }else{
        projectText=t.item.project;
      }
      label=`${t.item.name} (${projectText})`;
      if(t.type==='big' || t.type==='diybig') label='[BIG] '+label;
      let info='';
      if(page==='Todo'){info=t.type;}
      else if(page==='Work'){info=t.item.project;}
      prefix=page?`[${page}${info?` - ${info}`:''}] `:'';
      if(taskScheduledToday(t.type,t.item.id)) text.style.fontWeight='bold';
    }
    text.textContent=prefix+label;
    const btnBox=document.createElement('span');
    const up=document.createElement('button');
    up.textContent='Up';
    up.onclick=()=>moveTodayUp(i);
    const down=document.createElement('button');
    down.textContent='Down';
    down.onclick=()=>moveTodayDown(i);
    const btnR=document.createElement('button');
    btnR.textContent='Remove';
    btnR.onclick=()=>removeToday(i);
    const btnC=document.createElement('button');
    btnC.textContent='Complete';
    btnC.onclick=()=>completeToday(i);
    btnBox.appendChild(up);
    btnBox.appendChild(down);
    btnBox.appendChild(btnR);
    btnBox.appendChild(btnC);
    const num=document.createElement('span');
    num.textContent=(i+1)+'. ';
    li.appendChild(num);
    li.appendChild(text);
    li.appendChild(btnBox);
    ul.appendChild(li);
  });
  updateToggles();
}
// Removed selectTask for overdue/due lists
function addWorkToToday(id){
  const info=getWorkTaskInfo(id);
  if(!info) return;
  todayTasks.push({category:'work',type:'work',item:info.task,depth:info.depth});
  todayList.push({type:'work',id});
  saveData();
  renderToday();
  updateToggles();
}
function addDiyToToday(id){
  const info=getDiyTaskInfo(id);
  if(!info) return;
  todayTasks.push({category:'diy',type:'diy',item:info.task,depth:info.depth});
  todayList.push({type:'diy',id});
  saveData();
  renderToday();
  updateToggles();
}
function addStretchToToday(id){
  const task=stretchTasks.find(t=>t.id===id);
  if(!task) return;
  todayTasks.push({category:'stretch',type:'stretch',item:task});
  todayList.push({type:'stretch',id});
  saveData();
  renderToday();
}
function addBigToToday(id){
  const task=bigTasks.find(t=>t.id===id);
  if(!task) return;
  todayTasks.push({category:'big',type:'big',item:task});
  todayList.push({type:'big',id});
  saveData();
  renderToday();
}
function addDiyBigToToday(id){
  const task=diyBigTasks.find(t=>t.id===id);
  if(!task) return;
  todayTasks.push({category:'diybig',type:'diybig',item:task});
  todayList.push({type:'diybig',id});
  saveData();
  renderToday();
}

function moveTodayUp(idx){
  if(idx<=0) return;
  [todayTasks[idx-1],todayTasks[idx]]=[todayTasks[idx],todayTasks[idx-1]];
  [todayList[idx-1],todayList[idx]]=[todayList[idx],todayList[idx-1]];
  saveData();
  renderToday();
}

function moveTodayDown(idx){
  if(idx>=todayTasks.length-1) return;
  [todayTasks[idx],todayTasks[idx+1]]=[todayTasks[idx+1],todayTasks[idx]];
  [todayList[idx],todayList[idx+1]]=[todayList[idx+1],todayList[idx]];
  saveData();
  renderToday();
}
function addQuickItem(){
  const input=document.getElementById('quickInput');
  const name=input.value.trim();
  if(!name) return;
  todayList.push({type:'quick',id:nextId++,name,added:formatISO(new Date())});
  input.value='';
  rebuildToday();
  saveData();
  renderToday();
}
function removeToday(idx){
  const t=todayTasks.splice(idx,1)[0];
  todayList=todayList.filter(r=>{
    const rid = (r.id !== undefined) ? r.id : (r.originalId !== undefined ? r.originalId : undefined);
    return !(r.type===t.type && rid===t.item.id);
  });
  if(t.type==='quick') todayQuickHistory.push({name:t.item.name,added:t.item.added,done:false});
  saveData();
  renderSide();
  renderToday();
  updateToggles();
}
function clearToday(){
  todayTasks.forEach(t=>{ if(t.type==='quick') todayQuickHistory.push({name:t.item.name,added:t.item.added,done:false}); });
  todayTasks=[];
  todayList=[];
  saveData();
  renderSide();
  renderToday();
  updateToggles();
}
function computeNextDue(task,actionDate){const base=(task.from==='today')?new Date(actionDate):new Date(task.dueDate);let d=new Date(base);if(task.frequency==='daily')d.setDate(d.getDate()+task.interval);if(task.frequency==='weekly')d.setDate(d.getDate()+7*task.interval);if(task.frequency==='monthly')d.setMonth(d.getMonth()+task.interval);if(task.frequency==='yearly')d.setFullYear(d.getFullYear()+task.interval);return formatISO(d);}
function completeToday(idx){
  const t=todayTasks.splice(idx,1)[0];
  todayList=todayList.filter(r=>!(r.type===t.type&&r.id===t.item.id));
  const now=new Date();
  if(t.type==='quick'){
    todayQuickHistory.push({name:t.item.name,added:t.item.added,done:true,completed:formatISO(now)});
  }else if(t.type==='oneoff'){
    t.item.completedDates.push(formatISO(now));
    t.item.status='closed';
    t.item.closedDate=formatISO(now);
  }else if(t.type==='recurring'){
    t.item.completedDates.push(t.item.dueDate);
    t.item.lastDiff=Math.floor((now-new Date(t.item.dueDate))/(1000*60*60*24));
    t.item.lastCompleted=formatISO(now);
    t.item.dueDate=computeNextDue(t.item,now);
  }else if(t.type==='weekly'){
    const iso=nearestDueDate(t.item,now);
    if(!t.item.completedDates.includes(iso)) t.item.completedDates.push(iso);
    t.item.missedDates=t.item.missedDates.filter(d=>d!==iso);
  }else if(t.type==='work'){
    if(t.item.recurring){
      t.item.dueDate=computeNextDue(t.item,now);
    }else{
      t.item.status='closed';
    }
    saveWorkData();
  }else if(t.type==='diy'){
    t.item.status='closed';
    saveDiyData();
  }else if(t.type==='stretch'){
    t.item.completedDates.push(formatISO(now));
  }else if(t.type==='big'){
    t.item.completedDates.push(formatISO(now));
    t.item.status='closed';
    t.item.closedDate=formatISO(now);
  }else if(t.type==='diybig'){
    t.item.status='closed';
    saveDiyData();
  }else if(t.type==='dev'){
    t.item.completedDates.push(formatISO(now));
    saveParentingData();
  }
  // Overdue/Due categories removed
  saveData();
  renderSide();
  renderToday();
}
document.getElementById('todayList').addEventListener('dragstart',e=>{if(e.target.tagName==='LI'){e.dataTransfer.setData('text/plain',e.target.dataset.index);}});document.getElementById('todayList').addEventListener('dragover',e=>{e.preventDefault();});document.getElementById('todayList').addEventListener('drop',e=>{e.preventDefault();const from=+e.dataTransfer.getData('text/plain');const to=e.target.closest('li');if(!to)return;const idx=+to.dataset.index;const item=todayTasks.splice(from,1)[0];const ref=todayList.splice(from,1)[0];todayTasks.splice(idx,0,item);todayList.splice(idx,0,ref);saveData();renderToday();});
document.getElementById('workToggle').addEventListener('change',e=>{
  document.getElementById('workTaskList').classList.toggle('hidden',!e.target.checked);
  if(e.target.checked) renderWorkTasks();
  updateToggles();
});
document.getElementById('diyToggle').addEventListener('change',e=>{
  document.getElementById('diyTaskList').classList.toggle('hidden',!e.target.checked);
  if(e.target.checked) renderDiyTasks();
  updateToggles();
});
document.getElementById('stretchToggle').addEventListener('change',e=>{
  document.getElementById('stretchTaskList').classList.toggle('hidden',!e.target.checked);
  if(e.target.checked) renderStretchTasks();
});
document.getElementById('bigToggle').addEventListener('change',e=>{
  document.getElementById('bigTaskList').classList.toggle('hidden',!e.target.checked);
  if(e.target.checked) renderBigTasks();
  updateToggles();
});
document.getElementById('diyBigToggle').addEventListener('change',e=>{
  document.getElementById('diyBigTaskList').classList.toggle('hidden',!e.target.checked);
  if(e.target.checked) renderDiyBigTasks();
  updateToggles();
});
document.getElementById('devToggle').addEventListener('change',e=>{
  document.getElementById('devTaskList').classList.toggle('hidden',!e.target.checked);
  if(e.target.checked) renderDevTasks();
  updateToggles();
});

// Modal functionality for task selection
let modalCurrentWeekStart = new Date();

function openWeeklyTasksModal() {
  modalCurrentWeekStart = new Date();
  modalCurrentWeekStart.setDate(modalCurrentWeekStart.getDate() - modalCurrentWeekStart.getDay() + 1); // Start of current week (Monday)
  updateModalWeekLabel();
  renderModalWeeklyGrid();
  document.getElementById('weeklyTasksModal').style.display = 'block';
}

function closeWeeklyTasksModal() {
  document.getElementById('weeklyTasksModal').style.display = 'none';
}

function openOneOffTasksModal() {
  renderModalOneOffTable();
  document.getElementById('oneOffTasksModal').style.display = 'block';
}
function closeOneOffTasksModal() {
  document.getElementById('oneOffTasksModal').style.display = 'none';
}

function openRecurringTasksModal() {
  renderModalRecurringTable();
  document.getElementById('recurringTasksModal').style.display = 'block';
}
function closeRecurringTasksModal() {
  document.getElementById('recurringTasksModal').style.display = 'none';
}

function openWorkTasksModal() {
  renderModalWorkTable();
  document.getElementById('workTasksModal').style.display = 'block';
}
function closeWorkTasksModal() {
  document.getElementById('workTasksModal').style.display = 'none';
}

function openDiyTasksModal() {
  renderModalDiyTable();
  document.getElementById('diyTasksModal').style.display = 'block';
}
function closeDiyTasksModal() {
  document.getElementById('diyTasksModal').style.display = 'none';
}

function openBigTasksModal() {
  renderModalBigTable();
  document.getElementById('bigTasksModal').style.display = 'block';
}
function closeBigTasksModal() {
  document.getElementById('bigTasksModal').style.display = 'none';
}

function openStretchTasksModal() {
  renderModalStretchTable();
  document.getElementById('stretchTasksModal').style.display = 'block';
}
function closeStretchTasksModal() {
  document.getElementById('stretchTasksModal').style.display = 'none';
}

function changeModalWeek(direction) {
  modalCurrentWeekStart.setDate(modalCurrentWeekStart.getDate() + (direction * 7));
  updateModalWeekLabel();
  renderModalWeeklyGrid();
}

function updateModalWeekLabel() {
  const start = new Date(modalCurrentWeekStart);
  const end = new Date(modalCurrentWeekStart);
  end.setDate(end.getDate() + 6);
  document.getElementById('modalWeekLabel').textContent = 
    `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
}

function renderModalWeeklyGrid() {
  const grid = document.getElementById('modalWeeklyGrid');
  const headers = ['Task', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  
  grid.innerHTML = '';
  
  // Add headers
  headers.forEach(headerText => {
    const header = document.createElement('div');
    header.className = 'grid-header';
    header.textContent = headerText;
    grid.appendChild(header);
  });
  
  // Add tasks
  const openTasks = weeklyTasks.filter(t => t.status === 'open');
  if (openTasks.length === 0) {
    const row = document.createElement('div');
    row.textContent = 'No weekly tasks';
    row.style.gridColumn = '1 / -1';
    row.style.textAlign = 'center';
    row.style.padding = '2rem';
    grid.appendChild(row);
    return;
  }
  
  openTasks.forEach(task => {
    // Task cell with add to today button
    const taskCell = createModalTaskCell(task);
    grid.appendChild(taskCell);
    
    // Day cells
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach((day, idx) => {
      const cell = document.createElement('div');
      const date = new Date(modalCurrentWeekStart);
      date.setDate(modalCurrentWeekStart.getDate() + idx);
      const iso = formatISO(date);
      const due = task.days.includes(day);
      const completed = task.completedDates.includes(iso);
      
      const circle = document.createElement('span');
      circle.className = 'circle ' + (completed ? 'green' : due ? 'purple' : 'grey');
      circle.innerHTML = completed ? '&#10004;' : '';
      circle.onclick = () => toggleModalComplete(task.id, iso, due);
      cell.appendChild(circle);
      grid.appendChild(cell);
    });
  });
}

function renderModalOneOffTable() {
  const container = document.getElementById('modalOneOffTable');
  container.innerHTML = '';
  const open = (oneOffTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No one-off tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('oneoff', t.id, t.name);
    actionTd.appendChild(addBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalRecurringTable() {
  const container = document.getElementById('modalRecurringTable');
  container.innerHTML = '';
  const open = (recurringTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No recurring tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Frequency</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const freqTd = document.createElement('td');
    freqTd.style.padding = '8px';
    const freq = t.frequency || '';
    const interval = t.interval || 1;
    freqTd.textContent = interval>1 ? `${interval} ${freq}` : freq;
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('recurring', t.id, t.name);
    actionTd.appendChild(addBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(freqTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalWorkTable() {
  const container = document.getElementById('modalWorkTable');
  container.innerHTML = '';
  const rows = [];
  forEachWorkTask((t, depth) => {
    if (t.status !== 'open') return;
    rows.push({ t, depth });
  });
  if (rows.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No work tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Importance</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Urgency</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(({ t, depth }) => {
    const tr = document.createElement('tr');
    const projColor = (workDataStore.workProjects || []).find(p => p.name === t.project)?.color || '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    nameDiv.style.paddingLeft = (depth) + 'rem';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = projColor;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const impTd = document.createElement('td');
    impTd.style.padding = '8px';
    impTd.textContent = t.importance || '';
    const urgTd = document.createElement('td');
    urgTd.style.padding = '8px';
    urgTd.textContent = t.urgency || '';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('work', t.id, t.name);
    actionTd.appendChild(addBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(impTd);
    tr.appendChild(urgTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalDiyTable() {
  const container = document.getElementById('modalDiyTable');
  container.innerHTML = '';
  const rows = [];
  forEachDiyTask((t, depth) => {
    if (t.status !== 'open') return;
    rows.push({ t, depth });
  });
  if (rows.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No DIY tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Urgent</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(({ t, depth }) => {
    const tr = document.createElement('tr');
    const projColor = (diyDataStore.diyProjects || []).find(p => p.name === t.project)?.color || '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    nameDiv.style.paddingLeft = (depth) + 'rem';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = projColor;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    const typeDiv = document.createElement('div');
    typeDiv.textContent = t.type || '';
    typeDiv.style.fontSize = '0.75rem';
    typeDiv.style.opacity = '0.8';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    taskTd.appendChild(typeDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const urgTd = document.createElement('td');
    urgTd.style.padding = '8px';
    urgTd.textContent = t.urgent ? 'Yes' : 'No';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('diy', t.id, t.name);
    actionTd.appendChild(addBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(urgTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalBigTable() {
  const container = document.getElementById('modalBigTable');
  container.innerHTML = '';
  const open = (bigTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No big tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('big', t.id, t.name);
    actionTd.appendChild(addBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalStretchTable() {
  const container = document.getElementById('modalStretchTable');
  container.innerHTML = '';
  const open = (stretchTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No stretch tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Last Done</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const lastTd = document.createElement('td');
    lastTd.style.padding = '8px';
    const last = (t.completedDates && t.completedDates.length) ? formatUK(t.completedDates[t.completedDates.length-1]) : '';
    lastTd.textContent = last;
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('stretch', t.id, t.name);
    actionTd.appendChild(addBtn);
    tr.appendChild(taskTd);
    tr.appendChild(lastTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function createModalTaskCell(task) {
  const cell = document.createElement('div');
  cell.className = 'task-info';
  
  // Task details
  const detailsDiv = document.createElement('div');
  detailsDiv.className = 'task-details';
  
  const nameDiv = document.createElement('div');
  nameDiv.className = 'task-name';
  nameDiv.textContent = task.name;
  
  const projectDiv = document.createElement('div');
  projectDiv.className = 'task-meta';
  projectDiv.textContent = task.project;
  
  // Apply project color
  const proj = projects.find(p => p.name === task.project);
  if (proj) {
    projectDiv.style.color = proj.color;
  }
  
  detailsDiv.appendChild(nameDiv);
  detailsDiv.appendChild(projectDiv);
  
  // Actions
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'task-actions';
  
  // Add to Today button
  const addTodayBtn = document.createElement('button');
  addTodayBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B5A89A"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
  addTodayBtn.title = 'Add to Today';
  addTodayBtn.style.background = 'none';
  addTodayBtn.style.border = 'none';
  addTodayBtn.style.cursor = 'pointer';
  addTodayBtn.onclick = () => addTaskToToday('weekly', task.id, task.name);
  
  actionsDiv.appendChild(addTodayBtn);
  
  cell.appendChild(detailsDiv);
  cell.appendChild(actionsDiv);
  
  return cell;
}

function toggleModalComplete(id, day, due) {
  const task = weeklyTasks.find(t => t.id === id);
  if (!task) return;
  
  if (task.completedDates.includes(day)) {
    task.completedDates = task.completedDates.filter(d => d !== day);
    if (due && new Date(day) < new Date()) {
      if (!task.missedDates.includes(day)) task.missedDates.push(day);
    }
  } else {
    task.completedDates.push(day);
    if (due) {
      task.missedDates = task.missedDates.filter(d => d !== day);
    }
  }
  
  saveData();
  renderModalWeeklyGrid();
}

async function addTaskToToday(taskType, taskId, taskName) {
  try {
    const response = await fetch('/api/add-to-today', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskType, taskId, taskName })
    });
    
    if (response.ok) {
      // Regardless of server response shape, maintain local client shape
      todayList.push({ type: taskType, id: taskId });
      const result = await response.json(); // consume for completeness
      rebuildToday();
      renderToday();
      // Optionally refresh the modal grid to reflect any UI state
      if (document.getElementById('weeklyTasksModal').style.display === 'block') {
        renderModalWeeklyGrid();
      }
      if (document.getElementById('oneOffTasksModal').style.display === 'block') {
        renderModalOneOffTable();
      }
      if (document.getElementById('recurringTasksModal').style.display === 'block') {
        renderModalRecurringTable();
      }
      if (document.getElementById('workTasksModal').style.display === 'block') {
        renderModalWorkTable();
      }
      if (document.getElementById('diyTasksModal').style.display === 'block') {
        renderModalDiyTable();
      }
      if (document.getElementById('bigTasksModal').style.display === 'block') {
        renderModalBigTable();
      }
      if (document.getElementById('stretchTasksModal').style.display === 'block') {
        renderModalStretchTable();
      }
    } else {
      alert('Failed to add task to Today list');
    }
  } catch (error) {
    console.error('Error adding task to Today:', error);
    alert('Error adding task to Today list');
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const weekly = document.getElementById('weeklyTasksModal');
  const oneoff = document.getElementById('oneOffTasksModal');
  const recurring = document.getElementById('recurringTasksModal');
  if (event.target === weekly) closeWeeklyTasksModal();
  if (event.target === oneoff) closeOneOffTasksModal();
  if (event.target === recurring) closeRecurringTasksModal();
  const workM = document.getElementById('workTasksModal');
  const diyM = document.getElementById('diyTasksModal');
  const bigM = document.getElementById('bigTasksModal');
  const stretchM = document.getElementById('stretchTasksModal');
  if (event.target === workM) closeWorkTasksModal();
  if (event.target === diyM) closeDiyTasksModal();
  if (event.target === bigM) closeBigTasksModal();
  if (event.target === stretchM) closeStretchTasksModal();
}

async function init(){await loadData();rebuildToday();renderSide();renderToday();}
init();
</script>
</body>
</html>