<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Work Tasks</title>
<link rel="stylesheet" href="styles.css">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<style>
body { margin:0; padding:0; }
/* header styling removed to use global styles */
section { padding:1rem; }
.toggle { 
  cursor: pointer; 
  background: #C7BBB4; 
  padding: 0.5rem; 
  border-radius: 4px; 
  margin: 1rem 0; 
  text-align: center; 
}
.add-toggle { 
  background: #2B2C29; 
  color: #C7BBB4;
  font-size: 0.8rem; 
  padding: 0.5rem;
  transition: all 0.2s ease;
}
.add-toggle:hover {
  background: #C7BBB4;
  color: #2B2C29;
  box-shadow: 0 0 12px 2px #2B2C29;
}
.section-header{ font-size:1.2rem; font-weight:bold; position: relative; }

/* Pin star styling to match other pages */
.section-header .pin-star {
  position: absolute;
  top: 50%;
  right: 8px;
  transform: translateY(-50%);
  cursor: pointer;
  z-index: 10;
}

.section-header .pin-star svg {
  width: 16px;
  height: 16px;
}

.section-header .pin-star.pinned svg {
  fill: #F7F6F3;
  stroke: #2B2C29;
  stroke-width: 1;
}
.form-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1rem; align-items:center; }
.form-grid label{ display:flex; flex-direction:column; font-size:0.9rem; font-weight:bold; }
.form-grid input,.form-grid select{ width:100%; font-size:1rem; padding:0.4rem; margin-top:0.3rem; box-sizing:border-box; font-weight:normal; }
.hidden{ display:none !important; }
#taskHeader.task-header,.task-row{ display:grid; grid-template-columns:3fr 1fr 1fr 1fr 150px; gap:0.25rem; align-items:center; }
.task-row {
  background: var(--color-surface) !important; /* Match page background */
  border: 1px solid var(--color-border);
  padding: 0.25rem;
  margin-top: 0.25rem;
}

#taskHeader.task-header{ 
  font-weight:bold; 
  background: var(--color-table-header); 
  color: var(--color-toggle-text); 
  border: 1px solid var(--color-border); 
  position:sticky; 
  top:0; 
  z-index:1; 
  height: 3rem; 
  text-align: center; 
}
#taskHeader.task-header > div {
  display: flex;
  align-items: center;
  justify-content: center;
}
#taskList{
  height:400px;
  overflow-y:auto;
  overflow-x:hidden;
  width:calc(100% - 1rem);
  padding-right:1rem;
  min-height: 200px;
  position: relative;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background: var(--color-surface);
  padding-bottom: 15px; /* Space for resizer */
}
.task-list-resizer {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 10px;
  background: linear-gradient(to bottom, #FFA07A, var(--color-border)); /* Salmon shade */
  cursor: ns-resize;
  border-radius: 0 0 4px 4px;
  opacity: 0.9;
  transition: opacity 0.2s, background 0.2s;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
}
.task-list-resizer:hover {
  opacity: 1;
  background: linear-gradient(to bottom, #FF7F50, #FFA07A); /* Darker salmon on hover */
}
.task-list-resizer::before {
  content: '';
  width: 40px;
  height: 4px;
  background: #FF6347; /* Tomato shade for contrast */
  border-radius: 2px;
}
.task-icon-btn {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 30px;
}
.task-icon-btn:hover {
  background-color: var(--color-border);
}
.task-icon-btn.complete {
  color: #28a745;
}
.task-icon-btn.delete {
  color: #dc3545;
}
.task-icon-btn.edit {
  color: #007bff;
}
.task-icon-btn.info {
  color: #6c757d;
}
.task-icon-btn.add-sub {
  color: #17a2b8;
}
.drop-zone {
  border: 2px dashed var(--color-border);
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem 0;
  text-align: center;
  color: var(--color-text-muted);
  background: var(--color-bg);
  transition: all 0.3s ease;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--color-accent-soft);
  background: var(--color-surface);
  color: var(--color-text);
}
.task-row.dragging {
  opacity: 0.5;
}
.submit-btn {
  background: #C7BBB4;
  color: #2B2C29;
  border: none;
  border-radius: 12px;
  padding: 0.7rem 1.5rem;
  font-size: 1rem;
  font-weight: bold;
  box-shadow: 0 1px 2px rgba(44,44,44,0.04);
  transition: box-shadow 0.18s, background 0.18s, color 0.18s;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.submit-btn:hover {
  box-shadow: 0 0 12px 2px #2B2C29;
  background: #B5A89A;
  color: #E7E4D6;
}
.task-row div{word-break:break-word;}
.subtask{ margin-left:1rem; }
.controls button{ margin-left:0.25rem; font-size:0.7rem; }
.filter-grid{ display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem; }

.task-name-project {
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.task-name {
  font-weight: 500;
  color: var(--color-text); /* Ensure task name is black */
}
.project-name {
  font-size: 0.8em;
  opacity: 0.8;
}
.task-actions {
    display: flex;
    gap: 4px;
    justify-content: center;
    align-items: center;
}

/* Responsive font size for task rows */
.task-row {
  font-size: clamp(0.8rem, 2.5vw, 1rem);
}

/* Updated urgency and importance styles to color text instead of background */
.urgency-high {
  color: #ff4d4d; /* Bright red for high urgency */
}
.urgency-high-medium {
  color: #ff944d; /* Orange for high-medium urgency */
}
.urgency-medium {
  color: #ffcc00; /* Yellow for medium urgency */
}
.urgency-medium-low {
  color: #99cc00; /* Light green for medium-low urgency */
}
.urgency-low {
  color: #3399ff; /* Blue for low urgency */
}

.importance-high {
  color: #ff4d4d; /* Bright red for high importance */
  font-weight: bold;
}
.importance-high-medium {
  color: #ff944d; /* Orange for high-medium importance */
  font-weight: bold;
  font-style: italic;
}
.importance-medium {
  color: #ffcc00; /* Yellow for medium importance */
  font-style: italic;
}
.importance-medium-low {
  color: #99cc00; /* Light green for medium-low importance */
  opacity: 0.8;
}
.importance-low {
  color: #3399ff; /* Blue for low importance */
  opacity: 0.6;
}

/* Updated task list background to match page background */
#taskList {
  background: var(--color-surface); /* Match page background */
  border: 1px solid var(--color-border);
  border-radius: 4px;
  padding-bottom: 15px; /* Space for resizer */
}
.calendar-container{display:flex;gap:1rem;flex-wrap:wrap;}
#calendar{flex:1 1 300px;min-width:300px;}
#calendarTaskList{flex:1 1 200px;min-width:200px;border:1px solid #ccc;padding:0.5rem;max-height:400px;overflow-y:auto;}
.fc-task{background:#C7BBB4;margin:0.25rem 0;padding:0.25rem;border:1px solid #ccc;cursor:grab;}
.subtoggle{font-size:0.9rem;margin-top:0.5rem;}
.meeting-grid{display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-start;}
.meeting-col{flex:1 1 200px;min-width:200px;}
.meeting-card{border:1px solid #ccc;padding:0.5rem;margin:0.25rem 0;border-radius:4px;cursor:pointer;}
.meeting-past{background:#f0f0f0;}
.meeting-today{background:#d0ffd0;}
.meeting-upcoming{background:#f0f8ff;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);}
.modal-content{background:#fff;padding:1rem;border-radius:4px;max-width:90%;width:320px;}
.modal-content input,.modal-content textarea,.modal-content select{width:100%;margin-bottom:0.5rem;}
@media (max-width: 768px) {
  .task-row {
    font-size: 0.9rem;
  }
  #taskHeader.task-header, .task-row {
    grid-template-columns: minmax(120px, 1fr) 60px 60px 60px 40px 70px;
    gap: 0.2rem;
    align-items: stretch;
  }
  .task-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2px;
    align-content: center;
  }
  .task-icon-btn {
    width: 100%;
    height: 100%;
    padding: 2px;
  }
  .task-icon-btn svg {
    width: 14px;
    height: 14px;
  }
}
/* Force Actions column to 2x2 grid (override global nth-child flex) */
#taskSection .task-row > div:nth-child(5),
#taskSection .task-actions {
  display: grid !important;
  grid-template-columns: repeat(2, 28px);
  grid-auto-rows: 28px;
  gap: 6px;
  justify-content: center;
  align-content: center;
}
#taskSection .task-actions .task-icon-btn {
  width: 28px;
  height: 28px;
  padding: 0;
  border: none;
  background: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
@media (max-width: 600px) {
  html { font-size: 14px; }
  /* Ensure 5 consistent columns and visible cells on mobile */
  #taskHeader.task-header, .task-row { grid-template-columns: 3fr 1fr 1fr 1fr 150px; }
  #taskSection #taskHeader.task-header,
  #taskSection .task-row {
    grid-template-columns: 2fr 0.9fr 0.9fr 0.9fr 1.1fr; /* Task, Due, Importance, Urgency, Actions */
  }
  /* Unhide columns that global CSS may hide */
  #taskSection .task-row > div:nth-child(3), /* Importance */
  #taskSection .task-row > div:nth-child(4), /* Urgency */
  #taskSection .task-row > div:nth-child(5)  /* Actions */
  { display: block !important; }

  /* Actions column as a compact 2x2 grid like index one-off */
  .task-actions {
    display: grid;
    grid-template-columns: repeat(2, 28px);
    grid-auto-rows: 28px;
    gap: 6px;
    justify-content: center;
    align-content: center;
  }
  .task-actions .task-icon-btn {
    width: 28px;
    height: 28px;
    padding: 0;
    border: none;
    background: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
}
</style>
</head>
<body>
  <header>
    <h1>Work Tasks</h1>
  </header>
  <div id="nav-placeholder"></div>
  <script src="nav-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@5.11.3/main.min.js"></script>

  <section>
    <div class="toggle section-header" onclick="toggle('taskSection')">
      Tasks
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('taskSection')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
  <div id="taskSection" class="hidden" ondragover="allowDrop(event)" ondrop="dropOnRoot(event)">
      <div class="filter-grid">
        <label>Project<select id="filterProject"><option value="all">All</option></select></label>
        <label>Urgency<select id="filterUrgency"><option value="all">All</option><option>High</option><option>High/Medium</option><option>Medium</option><option>Medium/Low</option><option>Low</option></select></label>
        <label>Importance<select id="filterImportance"><option value="all">All</option><option>High</option><option>High/Medium</option><option>Medium</option><option>Medium/Low</option><option>Low</option></select></label>
        <label>Due<select id="filterDue"><option value="all">All</option><option value="overdue">Overdue</option><option value="today">Today</option></select></label>
        <label>Color By<select id="colorMode" onchange="renderTasks()"><option value="urgency">Urgency</option><option value="project">Project</option></select></label>
        <button class="submit-btn" onclick="renderTasks()">Apply</button>
      </div>

      <div id="taskHeader" class="task-header">
        <div>Task</div><div>Due</div><div>Importance</div><div>Urgency</div><div>Actions</div>
      </div>
      <div id="taskListContainer" style="position: relative; padding-bottom: 10px;">
        <div id="taskList" ondrop="dropOnRoot(event)" ondragover="allowDrop(event)">
          <div class="empty-message" style="text-align: center; color: var(--color-text-muted); padding: 2rem; font-style: italic;">
            No tasks yet. Add a task to get started!
          </div>
        </div>
        <!-- Resizer is added dynamically by JS -->
      </div>
      
      <div id="taskDropZone" class="drop-zone" ondrop="dropOnRoot(event)" ondragover="allowDrop(event)">
        <p>Drop tasks here to make them main tasks (remove from subtasks)</p>
      </div>

      <div class="toggle add-toggle" onclick="toggle('addTaskForm')">Add Task</div>
      <div id="addTaskForm" class="hidden subtoggle form-grid">
        <label>Name<input type="text" id="taskName"></label>
        <label>Project<select id="taskProject"></select></label>
        <label>Due Date<input type="date" id="taskDue"></label>
        <label>Importance<select id="taskImportance">
          <option>High</option>
          <option>High/Medium</option>
          <option>Medium</option>
          <option>Medium/Low</option>
          <option>Low</option>
        </select></label>
        <label>Urgency<select id="taskUrgency">
          <option>High</option>
          <option>High/Medium</option>
          <option>Medium</option>
          <option>Medium/Low</option>
          <option>Low</option>
        </select></label>
        <label><input type="checkbox" id="taskRecurring"> Recurring</label>
        <label class="recurring-field hidden">Frequency<select id="taskFreq">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select></label>
        <label class="recurring-field hidden">Interval<input type="number" id="taskInterval" value="1" min="1"></label>
        <label class="recurring-field hidden">Next due from<select id="taskFrom">
          <option value="intended">Intended due date</option>
          <option value="today">Completion date</option>
        </select></label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addTask()">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <section>
    <div class="toggle section-header" onclick="toggle('calendarSection')">
      Calendar
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('calendarSection')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="calendarSection" class="hidden">
      <div class="calendar-container">
        <div id="calendar"></div>
        <div>
          <h3>Tasks</h3>
          <div id="calendarTaskList"></div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <div class="toggle section-header" onclick="toggle('meetingSection')">
      Meetings
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('meetingSection')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="meetingSection" class="hidden">
      <button onclick="openMeetingModal()">Add Meeting</button>
      <div id="meetingColumns" class="meeting-grid"></div>
      <div style="margin-top:1rem;">
        <div class="toggle subtoggle" onclick="toggle('allMeetings')">View All Meetings</div>
        <div id="allMeetings" class="hidden meeting-grid"></div>
      </div>
    </div>
  </section>

  <div id="meetingModal" class="modal hidden">
    <div class="modal-content">
      <label>Title<input id="meetTitle"></label>
      <label>Project<select id="meetProject"></select></label>
      <label>Date<input type="date" id="meetDate"></label>
      <label>Attendees<textarea id="meetAttendees"></textarea></label>
      <label>Content<textarea id="meetContent"></textarea></label>
      <label>Outcomes<textarea id="meetOutcomes"></textarea></label>
      <div id="attachList"></div>
      <input id="attachInput" placeholder="Attachment URL"><button onclick="addAttachment()">Add</button>
      <div style="text-align:right;margin-top:0.5rem;">
        <button onclick="saveMeeting()">Save</button>
        <button onclick="deleteMeeting()">Delete</button>
        <button onclick="addFollowUp()">Add Follow-Up</button>
        <button onclick="addOutcomeTask()">Add as Task</button>
        <button onclick="closeMeetingModal()">Close</button>
      </div>
    </div>
    </div>
  </div>

  <div id="taskModal" class="modal hidden">
    <div class="modal-content">
      <label>Name<input id="taskModalName"></label>
      <label>Project<select id="taskModalProject"></select></label>
      <label>Due Date<input type="date" id="taskModalDue"></label>
      <label>Importance<select id="taskModalImportance">
        <option>High</option>
        <option>High/Medium</option>
        <option>Medium</option>
        <option>Medium/Low</option>
        <option>Low</option>
      </select></label>
      <label>Urgency<select id="taskModalUrgency">
        <option>High</option>
        <option>High/Medium</option>
        <option>Medium</option>
        <option>Medium/Low</option>
        <option>Low</option>
      </select></label>
      <label>Notes<textarea id="taskModalNotes"></textarea></label>
      <div style="text-align:right;margin-top:0.5rem;">
        <button onclick="saveTaskModal()">Save</button>
        <button onclick="closeTaskModal()">Cancel</button>
      </div>
    </div>
  </div>

  <section>
    <div class="toggle section-header" onclick="toggle('settingsSection')">
      Settings
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('settingsSection')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="settingsSection" class="hidden">
      <h3>Max Subtask Depth</h3>
      <p>This sets how many subtasks you can have nested</p>
      <label>Depth Level <input type="number" id="subtaskDepth" min="1" max="7" style="width: 80px;"></label>
      
      <h3 style="margin-top: 2rem;">Projects</h3>
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-end;">
        <label>Project Name <input type="text" id="workProjectName"></label>
        <label>Color <input type="color" id="workProjectColor" value="#ff0000"></label>
        <button onclick="addWorkProject()">Add</button>
      </div>
      <div id="workProjects"></div>
    </div>
  </section>

  <script>
let dataStore = {};
let workProjects = [];
let workTasks = [];
let workNextId = 1;
let maxSubDepth = 7;
let calendarEvents = [];
let calendarNextId = 1;
let calendar;
let calendarDraggable = null;
let meetings = [];
let meetingNextId = 1;
let currentMeeting = null;

function toggle(id){
  document.getElementById(id).classList.toggle('hidden');
}

function togglePin(sectionId) {
  const pinned = JSON.parse(localStorage.getItem('workPinnedSections')) || {};
  pinned[sectionId] = !pinned[sectionId];
  localStorage.setItem('workPinnedSections', JSON.stringify(pinned));
  
  const section = document.getElementById(sectionId);
  const pinStar = document.querySelector(`[onclick*="togglePin('${sectionId}')"]`);
  
  if (pinned[sectionId]) {
    section.classList.remove('hidden');
    if (pinStar) pinStar.classList.add('pinned');
  } else {
    if (pinStar) pinStar.classList.remove('pinned');
  }
}

function initializePinnedSections() {
  const pinned = JSON.parse(localStorage.getItem('workPinnedSections')) || {};
  
  Object.keys(pinned).forEach(sectionId => {
    if (pinned[sectionId]) {
      const section = document.getElementById(sectionId);
      const pinStar = document.querySelector(`[onclick*="togglePin('${sectionId}')"]`);
      
      if (section) section.classList.remove('hidden');
      if (pinStar) pinStar.classList.add('pinned');
    }
  });
}

function showRecurringFields(){
  const checked = document.getElementById('taskRecurring').checked;
  document.querySelectorAll('.recurring-field').forEach(el=>{
    if(checked) el.classList.remove('hidden');
    else el.classList.add('hidden');
  });
}
document.getElementById('taskRecurring').addEventListener('change', showRecurringFields);

async function loadData(){
  try{
    const res = await fetch('/api/work-data');
    if(!res.ok) return;
    dataStore = await res.json();
    workProjects = dataStore.workProjects || [];
    workTasks = dataStore.workTasks || [];
    workNextId = dataStore.workNextId || 1;
    maxSubDepth = dataStore.maxSubDepth || 7;
    calendarEvents = dataStore.calendarEvents || [];
    calendarNextId = dataStore.calendarNextId || 1;
    meetings = dataStore.meetings || [];
    meetingNextId = dataStore.meetingNextId || 1;
    renderProjects();
    renderTasks();
    renderCalendarTasks();
    renderMeetings();
    initCalendar();
  }catch(e){ console.error('load fail',e); }
}

async function saveData(){
  dataStore.workProjects = workProjects;
  dataStore.workTasks = workTasks;
  dataStore.workNextId = workNextId;
  dataStore.maxSubDepth = maxSubDepth;
  dataStore.calendarEvents = calendarEvents;
  dataStore.calendarNextId = calendarNextId;
  dataStore.meetings = meetings;
  dataStore.meetingNextId = meetingNextId;
  try{
    await fetch('/api/work-data',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(dataStore)});
  }catch(e){ console.error('save fail',e); }
}

function addWorkProject(){
  const name = document.getElementById('workProjectName').value.trim();
  const color = document.getElementById('workProjectColor').value;
  if(!name || workProjects.find(p=>p.name===name)) return;
  workProjects.push({name,color});
  document.getElementById('workProjectName').value='';
  renderProjects();
  renderMeetings();
  saveData();
}

function renderProjects(){
  const container = document.getElementById('workProjects');
  const sel = document.getElementById('taskProject');
  const filt = document.getElementById('filterProject');
  const depthInput = document.getElementById('subtaskDepth');
  
  if(depthInput){
    depthInput.value = maxSubDepth;
    depthInput.onchange = () => { maxSubDepth = parseInt(depthInput.value,10)||1; saveData(); };
  }
  
  container.innerHTML=''; 
  sel.innerHTML=''; 
  filt.innerHTML='<option value="all">All</option>';
  
  // Create table for projects grid
  const table = document.createElement('table');
  table.className = 'task-table';
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  table.style.marginTop = '1rem';
  
  const head = document.createElement('tr');
  head.innerHTML = '<th>Name</th><th>Task Status</th><th>Color</th><th>Action</th>';
  head.style.backgroundColor = '#f5f5f5';
  head.style.fontWeight = 'bold';
  table.appendChild(head);
  
  workProjects.forEach(p => {
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #ddd';
    
    // Name column
    const nameCell = document.createElement('td');
    nameCell.textContent = p.name;
    nameCell.style.color = p.color;
    nameCell.style.fontWeight = '500';
    nameCell.style.padding = '8px';
    
    // Task status column
    const statusCell = document.createElement('td');
    statusCell.style.padding = '8px';
    if (hasWorkTasks(p.name)) {
      statusCell.textContent = 'Tasks allocated';
      statusCell.style.color = '#81B29A';
    } else {
      statusCell.textContent = 'No tasks';
      statusCell.style.color = '#B5A89A';
    }
    
    // Color column
    const colorCell = document.createElement('td');
    colorCell.style.padding = '8px';
    const colorBox = document.createElement('div');
    colorBox.style.width = '30px';
    colorBox.style.height = '20px';
    colorBox.style.backgroundColor = p.color;
    colorBox.style.borderRadius = '4px';
    colorBox.style.border = '1px solid #ccc';
    colorCell.appendChild(colorBox);
    
    // Action column
    const actionCell = document.createElement('td');
    actionCell.style.padding = '8px';
    actionCell.style.display = 'flex';
    actionCell.style.gap = '8px';
    
    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.5 2C7.67157 2 7 2.67157 7 3.5V4H4C3.44772 4 3 4.44772 3 5C3 5.55228 3.44772 6 4 6H16C16.5523 6 17 5.55228 17 5C17 4.44772 16.5523 4 16 4H13V3.5C13 2.67157 12.3284 2 11.5 2H8.5ZM11 4H9V3.5C9 3.77614 9.22386 4 9.5 4H10.5C10.7761 4 11 3.77614 11 3.5V4Z" fill="#B5A89A"/><path d="M5 7V16C5 17.1046 5.89543 18 7 18H13C14.1046 18 15 17.1046 15 16V7H5Z" fill="#C7BBB4"/></svg>';
    deleteBtn.title = 'Delete Project';
    deleteBtn.style.background = 'none';
    deleteBtn.style.border = 'none';
    deleteBtn.style.cursor = 'pointer';
    deleteBtn.style.padding = '4px';
    deleteBtn.onclick = () => deleteWorkProject(p.name);
    actionCell.appendChild(deleteBtn);
    
    tr.appendChild(nameCell);
    tr.appendChild(statusCell);
    tr.appendChild(colorCell);
    tr.appendChild(actionCell);
    table.appendChild(tr);
    
    // Update selects
    const opt=document.createElement('option'); 
    opt.value=p.name; 
    opt.textContent=p.name; 
    sel.appendChild(opt);
    const opt2=opt.cloneNode(true); 
    filt.appendChild(opt2);
  });
  
  container.appendChild(table);
}

function hasWorkTasks(projectName) {
  return workTasks.some(t => !t.deleted && t.project === projectName);
}

function deleteWorkProject(name) {
  if (hasWorkTasks(name)) {
    alert('Cannot delete project with active tasks. Please delete or reassign tasks first.');
    return;
  }
  
  if (confirm(`Delete project "${name}"?`)) {
    const index = workProjects.findIndex(p => p.name === name);
    if (index !== -1) {
      workProjects.splice(index, 1);
      renderProjects();
      renderTasks();
      saveData();
    }
  }
}

function addTask(){
  const name=document.getElementById('taskName').value.trim();
  const project=document.getElementById('taskProject').value;
  const due=document.getElementById('taskDue').value;
  const importance=document.getElementById('taskImportance').value;
  const urgency=document.getElementById('taskUrgency').value;
  const rec=document.getElementById('taskRecurring').checked;
  if(!name) return;
  const task={
    id:String(workNextId).padStart(8,'0'),
    parent:null,
    name, project, dueDate: due,
    importance, urgency,
    recurring: rec,
    frequency: rec?document.getElementById('taskFreq').value:null,
    interval: rec?parseInt(document.getElementById('taskInterval').value,10):null,
    from: rec?document.getElementById('taskFrom').value:null,
    status:'open',
    subtasks:[],
    notes:''
  };
  workNextId++;
  workTasks.push(task);
  document.getElementById('taskName').value='';
  document.getElementById('taskDue').value='';
  document.getElementById('taskRecurring').checked=false;
  showRecurringFields();
  saveData();
  renderTasks();
}

function priorityVal(v){
  return {'High':5,'High/Medium':4,'Medium':3,'Medium/Low':2,'Low':1}[v]||1;
}

function urgencyClass(v){return "urgency-"+v.toLowerCase().replace(/[^a-z]+/g,"-");}
function importanceClass(v){return "importance-"+v.toLowerCase().replace(/[^a-z]+/g,"-");}
function getProjectColor(name){const p=workProjects.find(pr=>pr.name===name);return p?p.color:'#000';}

function computeNextDue(task,actionDate){
  let base=task.from==='today'?new Date(actionDate):new Date(task.dueDate);
  let d=new Date(base);
  if(task.frequency==='daily') d.setDate(d.getDate()+task.interval);
  if(task.frequency==='weekly') d.setDate(d.getDate()+7*task.interval);
  if(task.frequency==='monthly') d.setMonth(d.getMonth()+task.interval);
  return d.toISOString().slice(0,10);
}

function getTaskInfo(id, list=workTasks, depth=0, parent=null){
  for(const t of list){
    if(t.id===id) return {task:t,parent,depth};
    if(t.subtasks){
      const res=getTaskInfo(id,t.subtasks,depth+1,t);
      if(res) return res;
    }
  }
  return null;
}

function forEachTask(cb,list=workTasks,depth=0,parent=null){
  list.forEach(t=>{
    cb(t,depth,parent);
    if(t.subtasks) forEachTask(cb,t.subtasks,depth+1,t);
  });
}

function completeTask(id){
  const info=getTaskInfo(id);
  if(!info) return;
  const t=info.task;
  if(t.recurring){
    t.dueDate=computeNextDue(t,new Date());
  }else{
    t.status='closed';
  }
  deleteCalendarEvents(id);
  saveData();
  renderTasks();
}

function deleteTask(id){
  const info=getTaskInfo(id);
  if(!info) return;
  if(confirm('Delete task?')){
    if(info.parent){
      info.parent.subtasks=info.parent.subtasks.filter(x=>x!==info.task);
    }else{
      workTasks=workTasks.filter(x=>x!==info.task);
    }
    deleteCalendarEvents(id);
    saveData();
    renderTasks();
  }
}

function editTask(id){
  const info=getTaskInfo(id);
  if(!info) return;
  openTaskModal(info.task,true);
}

function addSubtask(id){
  const info=getTaskInfo(id);
  if(!info) return;
  if(info.depth+1>=maxSubDepth){ alert('Max subtask depth reached'); return; }
  openTaskModal({project:info.task.project}, false, info.task);
}

let draggingTaskId=null;
function startDrag(ev,id){
  draggingTaskId=id;
  ev.dataTransfer.effectAllowed = 'move';
  ev.target.classList.add('dragging');
  
  // Add visual feedback to drop zones
  const dropZone = document.getElementById('taskDropZone');
  dropZone.classList.add('drag-over');
}

function allowDrop(ev){
  ev.preventDefault();
  ev.dataTransfer.dropEffect = 'move';
}

function dropOnTask(ev,targetId){
  ev.preventDefault();
  ev.stopPropagation();
  
  // Clear visual feedback
  clearDragFeedback();
  
  if(draggingTaskId && draggingTaskId!==targetId){
    changeParent(draggingTaskId,targetId);
  }
  draggingTaskId = null;
}

function dropOnRoot(ev){
  ev.preventDefault();
  
  // Clear visual feedback
  clearDragFeedback();
  
  if(draggingTaskId){
    changeParent(draggingTaskId,null);
  }
  draggingTaskId = null;
}

function clearDragFeedback() {
  // Remove dragging class from all rows
  document.querySelectorAll('.task-row.dragging').forEach(row => {
    row.classList.remove('dragging');
  });
  
  // Remove drag-over class from drop zone
  const dropZone = document.getElementById('taskDropZone');
  if(dropZone) dropZone.classList.remove('drag-over');
}

function changeParent(taskId,newParentId){
  const info=getTaskInfo(taskId);
  if(!info) return;
  const newParentInfo=newParentId?getTaskInfo(newParentId):null;
  if(newParentInfo && isDescendant(taskId,newParentId)){
    alert('Cannot move into its own descendant');
    return;
  }
  const newDepth=newParentInfo?newParentInfo.depth+1:0;
  if(newDepth>=maxSubDepth){
    alert('Max subtask depth reached');
    return;
  }
  // remove from current parent
  if(info.parent){
    info.parent.subtasks=info.parent.subtasks.filter(t=>t!==info.task);
  }else{
    workTasks=workTasks.filter(t=>t!==info.task);
  }
  info.task.parent=newParentInfo?newParentInfo.task.id:null;
  if(newParentInfo){
    newParentInfo.task.subtasks=newParentInfo.task.subtasks||[];
    newParentInfo.task.subtasks.push(info.task);
  }else{
    workTasks.push(info.task);
  }
  saveData();
  renderTasks();
}

function isDescendant(rootId,targetId){
  const startInfo=getTaskInfo(rootId);
  if(!startInfo) return false;
  const stack=[startInfo.task];
  while(stack.length){
    const t=stack.pop();
    if(t.id===targetId) return true;
    if(t.subtasks) t.subtasks.forEach(st=>stack.push(st));
  }
  return false;
}



function renderTasks(){
  const list=document.getElementById('taskList');
  list.innerHTML='';
  const mode=document.getElementById('colorMode')?document.getElementById('colorMode').value:'urgency';
  const fProj=document.getElementById('filterProject').value;
  const fUrg=document.getElementById('filterUrgency').value;
  const fImp=document.getElementById('filterImportance').value;
  const fDue=document.getElementById('filterDue').value;
  const today=new Date().toISOString().slice(0,10);

  function passes(t){
    if(t.status!=='open') return false;
    if(fProj!=='all' && t.project!==fProj) return false;
    if(fUrg!=='all' && t.urgency!==fUrg) return false;
    if(fImp!=='all' && t.importance!==fImp) return false;
    if(fDue==='overdue' && t.dueDate && t.dueDate>=today) return false;
    if(fDue==='today' && t.dueDate!==today) return false;
    return true;
  }

  function sortTasks(arr){
    arr.sort((a,b)=>{
      const u=priorityVal(b.urgency)-priorityVal(a.urgency);
      if(u!==0) return u;
      return priorityVal(b.importance)-priorityVal(a.importance);
    });
    arr.forEach(t=>{ if(t.subtasks) sortTasks(t.subtasks); });
  }

  sortTasks(workTasks);
  forEachTask((t,depth)=>{
    if(!passes(t)) return;
    const row=document.createElement('div');
    row.className='task-row '+importanceClass(t.importance);
    if(mode==='urgency') row.classList.add(urgencyClass(t.urgency));

    row.style.marginLeft=(depth)+'rem';
    row.title=t.notes||'';
    row.draggable=true;
    row.ondragstart=ev=>startDrag(ev,t.id);
    row.ondragend=ev=>clearDragFeedback();
    row.ondragover=allowDrop;
    row.ondrop=ev=>dropOnTask(ev,t.id);

    const nameAndProjectDiv=document.createElement('div');
    nameAndProjectDiv.className='task-name-project';

    const nameDiv=document.createElement('div');
    nameDiv.textContent=t.name;
    nameDiv.className='task-name';

    const projDiv=document.createElement('div');
    projDiv.textContent=t.project;
    projDiv.className='project-name';

    if(mode==='project'){
      const color=getProjectColor(t.project);
      projDiv.style.color=color;
    }

    nameAndProjectDiv.appendChild(nameDiv);
    nameAndProjectDiv.appendChild(projDiv);

    const dueDiv=document.createElement('div'); dueDiv.textContent=t.dueDate||'';
    const impDiv=document.createElement('div'); impDiv.textContent=t.importance;
    const urgDiv=document.createElement('div'); urgDiv.textContent=t.urgency; urgDiv.className=urgencyClass(t.urgency);

    // Actions column (includes Complete, Edit, Add Subtask, Delete)
    const actionsCell=document.createElement('div');
    actionsCell.className='task-actions';

    const completeBtn=document.createElement('button');
    completeBtn.className='task-icon-btn complete';
    completeBtn.title='Complete Task';
    completeBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#81B29A"/><path d="m6 10 2 2 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    completeBtn.onclick=()=>completeTask(t.id);

    const editBtn=document.createElement('button');
    editBtn.className='task-icon-btn edit';
    editBtn.title='Edit Task';
    editBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5858 3.58579C14.3668 2.80474 15.6332 2.80474 16.4142 3.58579C17.1953 4.36683 17.1953 5.63316 16.4142 6.41421L15.6213 7.20711L12.7929 4.37868L13.5858 3.58579Z" fill="#B5A89A"/><path d="M11.3787 5.79289L3 14.1716V17H5.82842L14.2071 8.62132L11.3787 5.79289Z" fill="#C7BBB4"/></svg>';
    editBtn.onclick=()=>editTask(t.id);

    const subBtn=document.createElement('button');
    subBtn.className='task-icon-btn add-sub';
    subBtn.title='Add Subtask';
    subBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#17a2b8"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    subBtn.onclick=()=>addSubtask(t.id);

    const delBtn=document.createElement('button');
    delBtn.className='task-icon-btn delete';
    delBtn.title='Delete Task';
    delBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="8" width="8" height="8" rx="2" fill="#E07A5F"/><rect x="9" y="11" width="2" height="3" rx="1" fill="#fff"/><rect x="8" y="4" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
    delBtn.onclick=()=>deleteTask(t.id);

    // Order for 2x2 grid
    actionsCell.appendChild(completeBtn);
    actionsCell.appendChild(editBtn);
    actionsCell.appendChild(subBtn);
    actionsCell.appendChild(delBtn);

    row.appendChild(nameAndProjectDiv);
    row.appendChild(dueDiv);
    row.appendChild(impDiv);
    row.appendChild(urgDiv);
    row.appendChild(actionsCell);
    list.appendChild(row);
  });
  
  // Handle empty state and add resizer
  const hasVisibleTasks = list.children.length > 0;
  if (!hasVisibleTasks) {
    const emptyMsg = document.createElement('div');
    emptyMsg.className = 'empty-message';
    emptyMsg.style.textAlign = 'center';
    emptyMsg.style.color = 'var(--color-text-muted)';
    emptyMsg.style.padding = '2rem';
    emptyMsg.style.fontStyle = 'italic';
    emptyMsg.textContent = 'No tasks yet. Add a task to get started!';
    list.appendChild(emptyMsg);
  }
  
  // Always add the resizer at the end
  const container = document.getElementById('taskListContainer');
  let resizer = document.getElementById('taskListResizer');
  if (!resizer) {
    resizer = document.createElement('div');
    resizer.className = 'task-list-resizer';
    resizer.id = 'taskListResizer';
    container.appendChild(resizer);
  }
  
  renderCalendarTasks();
}

function renderCalendarTasks(){
  const cont=document.getElementById('calendarTaskList');
  cont.innerHTML='';
  forEachTask((t,depth)=>{
    if(t.status!=='open') return;
    const div=document.createElement('div');
    div.className='fc-task';
    div.textContent=t.name;
    div.dataset.id=t.id;
    div.dataset.title=t.name;
    div.style.marginLeft=depth+'rem';
    cont.appendChild(div);
  });
  if(calendarDraggable){
    calendarDraggable.destroy();
  }
  calendarDraggable=new FullCalendar.Draggable(cont,{itemSelector:'.fc-task',eventData:el=>({title:el.dataset.title,taskId:el.dataset.id})});
}

function initCalendar(){
  const el=document.getElementById('calendar');
  calendar=new FullCalendar.Calendar(el,{
    initialView:'dayGridMonth',
    height:'auto',
    editable:true,
    droppable:true,
    eventDurationEditable:true,
    events:calendarEvents,
    eventReceive:info=>{
      info.event.setProp('id',String(calendarNextId++));
      info.event.setExtendedProp('taskId',info.draggedEl.dataset.id);
      saveCalendar();
    },
    eventDrop:saveCalendar,
    eventResize:saveCalendar,
    eventClick:info=>{ if(confirm('Remove this scheduled task?')){ info.event.remove(); saveCalendar(); } }
  });
  calendar.render();
}

function saveCalendar(){
  calendarEvents=calendar.getEvents().map(ev=>({id:ev.id,title:ev.title,start:ev.startStr,end:ev.endStr,taskId:ev.extendedProps.taskId||''}));
  saveData();
}
function deleteCalendarEvents(taskId){
  if(!calendar) return;
  calendar.getEvents().forEach(ev=>{if(ev.extendedProps.taskId===taskId) ev.remove();});
  saveCalendar();
}
function showInfo(t){
  alert(`Name: ${t.name}\nProject: ${t.project}\nDue: ${t.dueDate||''}\nImportance: ${t.importance}\nUrgency: ${t.urgency}\nNotes: ${t.notes||''}`);
}
function meetingStatus(date){
  const today=new Date().toISOString().slice(0,10);
  if(!date) return 'meeting-upcoming';
  if(date<today) return 'meeting-past';
  if(date===today) return 'meeting-today';
  return 'meeting-upcoming';
}

function formatShortUK(date){
  const d=new Date(date);
  if(isNaN(d)) return '';
  return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'2-digit'});
}

function renderMeetings(){
  const colsCont=document.getElementById('meetingColumns');
  const allCont=document.getElementById('allMeetings');
  colsCont.innerHTML='';
  allCont.innerHTML='';
  const projects=[...new Set(meetings.map(m=>m.project||'Ad Hoc'))];
  projects.forEach(name=>{
    const projectMeetings=meetings.filter(m=>(m.project||'Ad Hoc')===name);
    if(projectMeetings.length===0) return;
    const col=document.createElement('div');
    col.className='meeting-col';
    col.innerHTML='<h3>'+name+'</h3>';
    projectMeetings.forEach(m=>{
      const card=document.createElement('div');
      card.className='meeting-card '+meetingStatus(m.date);
      const date=formatShortUK(m.date);
      card.textContent=date?`${m.title} - ${date}`:m.title;
      card.onclick=()=>openMeetingModal(m.id);
      col.appendChild(card);
      allCont.appendChild(card.cloneNode(true));
    });
    colsCont.appendChild(col);
  });
}

function openMeetingModal(id, data){
  if(id){
    currentMeeting=meetings.find(m=>m.id===id);
  }else{
    currentMeeting=data||{id:String(meetingNextId++),title:'',project:'',date:'',attendees:'',content:'',outcomes:'',attachments:[],followupOf:null};
  }
  const projSel=document.getElementById('meetProject');
  projSel.innerHTML='<option value="">Ad Hoc</option>';
  workProjects.forEach(p=>{const o=document.createElement('option');o.value=p.name;o.textContent=p.name;projSel.appendChild(o);});
  document.getElementById('meetTitle').value=currentMeeting.title;
  document.getElementById('meetProject').value=currentMeeting.project;
  document.getElementById('meetDate').value=currentMeeting.date;
  document.getElementById('meetAttendees').value=currentMeeting.attendees;
  document.getElementById('meetContent').value=currentMeeting.content;
  document.getElementById('meetOutcomes').value=currentMeeting.outcomes;
  renderAttachments();
  document.getElementById('meetingModal').classList.remove('hidden');
}

function closeMeetingModal(){
  document.getElementById('meetingModal').classList.add('hidden');
  currentMeeting=null;
}

function renderAttachments(){
  const list=document.getElementById('attachList');
  list.innerHTML='';
  if(!currentMeeting.attachments) currentMeeting.attachments=[];
  currentMeeting.attachments.forEach((a,i)=>{
    const div=document.createElement('div');
    const link=document.createElement('a');
    link.href=a; link.textContent=a; link.target='_blank';
    const del=document.createElement('button');
    del.textContent='x';
    del.style.marginLeft='0.25rem';
    del.onclick=()=>{currentMeeting.attachments.splice(i,1);renderAttachments();};
    div.appendChild(link); div.appendChild(del);
    list.appendChild(div);
  });
}

function addAttachment(){
  const url=document.getElementById('attachInput').value.trim();
  if(url){ currentMeeting.attachments.push(url); document.getElementById('attachInput').value=''; renderAttachments(); }
}

function saveMeeting(){
  currentMeeting.title=document.getElementById('meetTitle').value.trim();
  currentMeeting.project=document.getElementById('meetProject').value;
  currentMeeting.date=document.getElementById('meetDate').value;
  currentMeeting.attendees=document.getElementById('meetAttendees').value;
  currentMeeting.content=document.getElementById('meetContent').value;
  currentMeeting.outcomes=document.getElementById('meetOutcomes').value;
  if(!meetings.find(m=>m.id===currentMeeting.id)){
    meetings.push(currentMeeting);
  }
  saveData();
  renderMeetings();
  closeMeetingModal();
}

function deleteMeeting(){
  if(!currentMeeting) return;
  if(confirm('Delete meeting?')){
    meetings=meetings.filter(m=>m!==currentMeeting);
    saveData();
    renderMeetings();
    closeMeetingModal();
  }
}

function addFollowUp(){
  const follow={id:String(meetingNextId++),title:currentMeeting.title,project:currentMeeting.project,date:'',attendees:currentMeeting.attendees,content:currentMeeting.outcomes, outcomes:'',attachments:[],followupOf:currentMeeting.id};
  openMeetingModal(null, follow);
}

function addOutcomeTask(){
  const ta=document.getElementById('meetOutcomes');
  const text=ta.value.substring(ta.selectionStart, ta.selectionEnd) || ta.value;
  if(!text.trim()) return;
  const task={name:text.trim(),project:currentMeeting.project,dueDate:'',importance:'Medium',urgency:'Medium',notes:'from meeting '+currentMeeting.id};
  openTaskModal(task);
}

let pendingTask=null;
let editingTask=null;
let modalParent=null;
function openTaskModal(defaults={}, isEdit=false, parent=null){
  editingTask=isEdit?defaults:null;
  modalParent=parent;
  pendingTask=Object.assign({name:'',project:'',dueDate:'',importance:'Medium',urgency:'Medium',notes:''}, isEdit?defaults||{}:defaults||{});
  const projSel=document.getElementById('taskModalProject');
  projSel.innerHTML='<option value="">Ad Hoc</option>';
  workProjects.forEach(p=>{const o=document.createElement('option');o.value=p.name;o.textContent=p.name;projSel.appendChild(o);});
  document.getElementById('taskModalName').value=pendingTask.name;
  document.getElementById('taskModalProject').value=pendingTask.project;
  document.getElementById('taskModalDue').value=pendingTask.dueDate;
  document.getElementById('taskModalImportance').value=pendingTask.importance;
  document.getElementById('taskModalUrgency').value=pendingTask.urgency;
  document.getElementById('taskModalNotes').value=pendingTask.notes||'';
  document.getElementById('taskModal').classList.remove('hidden');
}

function closeTaskModal(){
  document.getElementById('taskModal').classList.add('hidden');
  pendingTask=null;
  editingTask=null;
  modalParent=null;
}

function saveTaskModal(){
  if(!pendingTask) return;
  const target = editingTask || pendingTask;
  target.name=document.getElementById('taskModalName').value.trim();
  target.project=document.getElementById('taskModalProject').value;
  target.dueDate=document.getElementById('taskModalDue').value;
  target.importance=document.getElementById('taskModalImportance').value;
  target.urgency=document.getElementById('taskModalUrgency').value;
  target.notes=document.getElementById('taskModalNotes').value;
  if(!editingTask){
    const full={id:String(workNextId).padStart(8,'0'),parent:modalParent?modalParent.id:null,recurring:false,frequency:null,interval:null,from:null,status:'open',subtasks:[],...target};
    workNextId++;
    if(modalParent){
      modalParent.subtasks=modalParent.subtasks||[];
      modalParent.subtasks.push(full);
    }else{
      workTasks.push(full);
    }
  }
  saveData();
  renderTasks();
  closeTaskModal();
}

document.addEventListener('DOMContentLoaded', () => {
  const colorModeSelect = document.getElementById('colorMode');

  // Load the last selected color mode from localStorage
  const savedColorMode = localStorage.getItem('colorMode');
  if (savedColorMode) {
    colorModeSelect.value = savedColorMode;
  }

  // Save the selected color mode to localStorage on change
  colorModeSelect.addEventListener('change', () => {
    localStorage.setItem('colorMode', colorModeSelect.value);
  });

  // Task list resizer functionality (delegated and robust)
  const taskList = document.getElementById('taskList');
  let isResizing = false;

  // Load saved height
  const savedHeight = localStorage.getItem('taskListHeight');
  if (savedHeight && taskList) {
    taskList.style.height = savedHeight + 'px';
  }

  // Delegate mousedown from taskList to resizer child (works after re-render)
  if (taskList) taskList.addEventListener('mousedown', (e) => {
    const target = e.target;
    if (target && target instanceof HTMLElement && target.id === 'taskListResizer') {
      isResizing = true;
      document.body.style.cursor = 'ns-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (!isResizing || !taskList) return;
    const rect = taskList.getBoundingClientRect();
    const newHeight = e.clientY - rect.top;
    if (newHeight >= 200 && newHeight <= 900) {
      taskList.style.height = newHeight + 'px';
    }
  });

  document.addEventListener('mouseup', () => {
    if (!isResizing) return;
    isResizing = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    if (taskList) {
      const currentHeight = parseInt(taskList.style.height || '0', 10);
      if (currentHeight) localStorage.setItem('taskListHeight', String(currentHeight));
    }
  });
});

loadData();
initializePinnedSections();
</script>
</body>
</html>
